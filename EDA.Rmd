---
title: "EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview
Netflix has 

## Data source
https://www.kaggle.com/shivamb/netflix-shows

## Data in 
```{r, eval = FALSE}
unzip("netflix-shows.zip")
```

```{r}
library(data.table)
library(ggplot2)
data_in <- data.table(read.csv("netflix_titles.csv", 
                               stringsAsFactors = FALSE))

# most of the obs of a data scientist - dealing with inconsistent / dirty 
# data
data_in[, date_added := gsub(", ", ",", date_added)]
data_in[, date_added := gsub("^ ", "", date_added)]
data_in[date_added == "", 
        date_added := paste0("January 01,", release_year)]

data_in[, date_added := as.Date(date_added, format = "%B %d,%Y")]
```

- Ratings

```{r}
ggplot(data_in, aes(x = rating)) +
  geom_histogram(stat = "count") +
  ggtitle("Histogram of ratings")
# todo: Need to have a look at the different types of ratings
```
```{r}
library(dplyr)
library(tidyr)

countries <- data_in %>% 
  mutate(symbols = strsplit(country, " ,")) %>%
  unnest(symbols) %>%
  mutate(symbols = strsplit(symbols, ",")) %>%
  unnest(symbols) %>%
  data.table()

countries[, symbols := gsub("^ ", "", symbols),]

```

```{r}

titles_by_countries <- countries[, .(title, show_id, symbols, date_added)]

counted_titles_per_country <- titles_by_countries[, .(counts = .N), .(symbols)]
setorder(counted_titles_per_country,-counts)

counted_titles_per_country %>%
  top_n(15) %>%
  ggplot(aes(x = symbols, y = counts)) +
  geom_point()

```

Quite a lot of movies are produced / created in the United States. That makes 
sense from the point of view that the Western / Hollywood culture has been 
overtaking everything. On the other hand, we are talking a three times more
movies produces in the States than in the second most popular country - India.
It would be interesting to compare this to the countries of the viewers of 
Netflix.

- most popular actors as defined by how many titles they are in
```{r}
actors <- data_in %>% 
  mutate(cast = strsplit(cast, " ,")) %>%
  unnest(cast) %>%
  mutate(cast = strsplit(cast, ",")) %>%
  unnest(cast) %>%
  data.table()

actors[, cast := gsub("^ ", "", cast),]

titles_by_actors <- actors[, .(show_id, title, cast)]

counted_titles_per_actor <- titles_by_actors[, .(counts = .N), .(cast)]
setorder(counted_titles_per_actor,-counts)

counted_titles_per_actor %>%
  top_n(10) %>%
  ggplot(aes(x = cast, y = counts)) +
  geom_point()

```
Lots of what I assume are Indian names.


- is there a good last name for an actor?
```{r}
library(tidytext)
counted_titles_per_actor[, id := 1:.N]
tokenized <- counted_titles_per_actor %>%
  unnest_tokens(word, cast)

tokenized %>%
  group_by(id) %>%
  count(id)

counted_titles_per_actor[, .(last_name = grep("", cast, value = TRUE))]
```


- most popular directors as defined by how many things they have directed + 
how many other directors were in it

```{r}
directors <- data_in %>% 
  mutate(director = strsplit(director, ", ")) %>%
  unnest(director) %>%
  mutate(director = strsplit(director, ",")) %>%
  unnest(director) %>%
  data.table()

# directors[, directors := gsub("^ ", "", directors),]

titles_by_directors <- directors[, .(show_id, title, director)]

counted_titles_per_directors <- titles_by_directors[, .(counts = .N), .(director)]
setorder(counted_titles_per_directors,-counts)

# View(counted_titles_per_actor)

counted_titles_per_directors %>%
  top_n(10) %>%
  ggplot(aes(x = director, y = counts)) +
  geom_point()

```

Curious - that is a lot more productions per director than I would have 
expected. Let's see how many of these were co-chaired.

```{r}
count_directors_per_title <- titles_by_directors[, .N, .(show_id, title)]
ggplot(count_directors_per_title, aes(x = N)) +
  geom_histogram()
```

There is a movie with 10 directors? That is a lot of people. Let see some more 
details.

```{r}
movie_titles <- count_directors_per_title[N > 4, c("title", "show_id")]

data_in[show_id %in% movie_titles$show_id]

```

Alright for the shows, if a bit surprising for the movies. Important to mention 
that there are prductions in this data set that have no directors. To be precise,
there are `r round(nrow(data_in[director == ""]) / nrow(data_in) * 100, 2)`%
of productions like that. 
Missing values can be sometimes imputed, but in this case there is nothing we
can really do about this lack besides be aware of it and try to take it into 
account. 


- average number of actors quoted per title
```{r}
number_of_actors <- actors[, .N, .(show_id, title)]

ggplot(number_of_actors, aes(x = N)) +
  geom_histogram() +
  ggtitle("Average number of actor quoted per title")

```
- do we have only one id per row? - general housekeeping 
```{r}
length(unique(data_in$show_id)) == nrow(data_in)
```

- do we have duplicate names? 
Having a look at this by type as well since it is a practice to have a movie
followed by a show of the same name.
```{r}
counted_titles <- data_in[,.N ,.(title, type)]
setorder(counted_titles, -N)
counted_titles[N > 1]
```
- common bigrams / trigrams in the description

- sentiment analysis of the titles - crude sums, might be better to associate 
the words with the ncp sentiments? would be more precise correlation for the 
categories
```{r}
description_text <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, "word") %>%
  anti_join(stop_words) %>%
  inner_join(get_sentiments("afinn")) %>%
  data.table()

overall_sum_sentiments <- description_text[
  , .(sentiment_score = sum(value)), .(show_id)]

```

- how does overall sentiment score correlate to the categories that a given 
show is slotted in?

```{r}
categories <- data_in %>% 
  mutate(categories = strsplit(listed_in, ", ")) %>%
  unnest(categories) %>%
  mutate(categories = strsplit(categories, ",")) %>%
  unnest(categories) %>%
  data.table()

categories_short <- unique(categories[, .(categories, show_id, title)])

categories_afinn <- merge(categories_short, overall_sum_sentiments, by = "show_id")

unique(categories_afinn$categories)

ggplot(categories_afinn, aes(x = categories, y = sentiment_score)) +
  geom_boxplot()
```

One score is not very representative of a whole movie, especially since we are 
calculating it on a description, rather than the whole script of the movie.
That makes the numeric representation of the movie a very high-level
representation of it and we expect a lot of details to get lost. 

That being the case it is perhaps more illuminating to look at associated words,
rather than associated numbers.

- words associated with the descriptions by category
```{r}
description_text_nrc <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, "word") %>%
  anti_join(stop_words) %>%
  inner_join(get_sentiments("nrc")) %>%
  data.table()

description_text_nrc


categories_nrc <- merge(categories_short, description_text_nrc, by = "show_id",
                        allow.cartesian = TRUE)

```


Let's have a look at what the distributions are. We have a lot of categories, 
some of them duplicating for movies and TV shows. For ease of access, let's 
have a look at the movies only.
```{r}
categories_nrc[show_id == 70142827]

categories_nrc <- merge(categories_nrc, data_in[, .(show_id, type)])

ggplot(categories_nrc[
  type == "Movie" & sentiment %in% c("negative", "positive"),],
  aes(x = sentiment, fill = sentiment)) +
  geom_histogram(stat="count")+
  facet_wrap(~categories, scales = "free") +
  # theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Positive and negative sentiment counts per movie category")

ggplot(categories_nrc[
  type != "Movie" & sentiment %in% c("negative", "positive"),],
  aes(x = sentiment, fill = sentiment)) +
  geom_histogram(stat="count")+
  facet_wrap(~categories, scales = "free") +
  # theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Positive and negative sentiment counts per TV show category")


```


- most popular groups
```{r}
categories %>%
  group_by(type) %>%
  count(categories) %>%
  arrange(desc(n)) %>%
  group_by(type) %>%
  top_n(5) %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = categories, y = n, fill = categories)) +
  geom_col() +
  facet_wrap(~type, scales = "free") +
  theme(axis.text.x = element_text(angle = 45))

```

- inverse frequency on the description
```{r}
text <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, title, word) %>%
  anti_join(stop_words)

word_tf_idf <- text %>%
  count(show_id, word) %>%
  bind_tf_idf(word, show_id, n) %>%
  arrange(desc(tf_idf))

word_tf_idf %>%
  mutate(word = factor(word, levels = rev(unique(word)))) %>% 
  arrange(desc(tf_idf)) %>%
  top_n(15) %>% 
  ggplot(aes(word, tf_idf, fill = show_id)) +
  geom_col(show.legend = TRUE) +
  labs(x = NULL, y = "tf-idf") +
  coord_flip() +
  ggtitle("The 15 rarest words in the dataset")

```
- most niche groups - the shows in them are not listed in many more groups on 
average
```{r}
total_number_of_categories_per_show <- categories_short[, .N, .(show_id)]

categories_with_counts <- merge(
  categories_short, total_number_of_categories_per_show)

categories_with_counts[, percentage_of_categories := 1 / N]
mean_per_category <- categories_with_counts[
  , .(percentage_of_categories = mean(percentage_of_categories)), .(categories)]




ggplot(mean_per_category[percentage_of_categories > 0.5],
       aes(x = categories, y = percentage_of_categories)) +
  geom_point() +
  ggtitle("Most niche categories (appearing on their own most of the time")

```

- correlations of the categories
```{r}
ggplot(categories, aes(x = categories, y = categories)) +
  geom_point()


# run correlations on the dummified categories
library(caret)
dmy <- dummyVars(" ~ .", data = categories[, .(show_id, categories)])
one_hot_encoded <- data.table(predict(dmy, newdata = categories))
one_hot_encoded[, .(lapply(.SD, sum)), .(show_id)]

one_hot_encoded <- one_hot_encoded %>%
  group_by(show_id) %>%
  summarise_each(funs(sum))

new_names <- gsub("categories", "", names(one_hot_encoded))
setnames(one_hot_encoded, names(one_hot_encoded), new_names)

correlations <- cor(one_hot_encoded[,-1])
corrplot::corrplot(correlations, method = "number")
```

The correlations plot is very bare - overall we rarely have something that 
correlates even at 40%, nevermind higher strength correlations.



- how does the distribution of movies change over time - movies produced in 
different countries added in 

```{r}
titles_by_countries
counted_titles_by_date_and_country <- titles_by_countries[
  , .N, .(symbols, year(date_added))]

required_countries <- counted_titles_by_date_and_country[
  year == 2019 & N > 50, symbols]

counted_titles_by_date_and_country %>%
  filter(symbols  %in% required_countries) %>%
  ggplot(aes(x = year, y = log10(N), col = symbols)) +
  geom_line() +
  ggtitle("Additions of shows and movies by year per country (log 10)")

```

- TV shows against movies over time
```{r}
# something sketchy happening here
counts_type <- data_in[, .N, .(type, year(date_added))]
max(counts_type$N)
ggplot(counts_type, aes(x = year, y = N, col = type)) +
  geom_line() +
  ggtitle("Additions of shows and movies by year")
```