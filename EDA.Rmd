---
title: "EDA"
output: html_document
---

## Overview
Netflix has become a staple of entertainment for many households across the
world. As such it shapes what those households have access to in terms of 
culture. This markdown will have a look at some of the features of a Netflix 
dataset that was released on Kaggle. 

## Data source
https://www.kaggle.com/shivamb/netflix-shows



## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 12)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

```

## Libraries used

```{r loading_libraries}
library(ggplot2)
library(data.table)
library(DT)
library(dplyr)
library(tidyr)
library(tidytext)
library(caret)
```

```{r set_ggplot_theme}
large_font_size <- theme(axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        plot.title = element_text(size = 20))

```

## Data in 
```{r, eval = FALSE}
unzip("netflix-shows.zip")
```

```{r data_in_&_clean}
data_in <- data.table(read.csv("netflix_titles.csv",
                               stringsAsFactors = FALSE))

# large chunk of the job of a data scientist - dealing with inconsistent /
# dirty data
data_in[, date_added := gsub(", ", ",", date_added)]
data_in[, date_added := gsub("^ ", "", date_added)]
data_in[date_added == "",
        date_added := paste0("January 01,", release_year)]

data_in[, date_added := as.Date(date_added, format = "%B %d,%Y")]

DT::datatable(head(data_in, 1))
```

#### Checks

Given our data set there are two general housekeeping things that I am
interested in at first:

- do we have only one id per row?

```{r}
length(unique(data_in$show_id)) == nrow(data_in)
```

- do we have duplicate names? 
Having a look at this by type as well since it is a practice to have a movie
followed by a show of the same name.

```{r}
counted_titles <- data_in[, .N, .(title, type)]
setorder(counted_titles, -N)

```
We have `r nrow(counted_titles[N > 1])` titles in total that have been repeated.
For this reason when we are interested in number of something per group (actors,
words in description and so on), we should be grouping by the show_id rather
than the title.

## Analysis 

There are several interesting questions we could be
answering with this data. As a first step we will be starting with the ratings
and their ditribution. 

**Disclaimer:**

Given that we will not be
doing any modeling with the data, we will be using all of it in our exploration.
If we were planning to, for example, try to predict categories using 
the description, we would have to split this data into test / train 
datasets as a first step before we do any exploration. 

#### Ratings
Some of our titles are rated TV-* and some have the typical ratings that
are associated with movies. This is why we split them by type of medium.
However, this type of split is not ideal either, since some movies are made for
TV and thus would have the TV ratings. To confound things further, there are 
some movies without a rating at all (the first bar). For our sample their number 
is `r nrow(data_in[rating == ""])`, which is not that high and we could
probably jsut drop them if we are trying to use the ratings column. However,
it is important to keep in mind.
```{r}
ggplot(data_in, aes(x = rating, fill = type)) +
  geom_histogram(stat = "count") +
  ggtitle("Histogram of ratings") +
  facet_wrap(~type, scales = "free")
```

#### Country where a title was produced

Quite a lot of movies are produced / created in the United States. That makes 
sense from the point of view that the Western / Hollywood culture has been 
overtaking movie production. On the other hand, we are talking a three times
more
movies produces in the States than in the second most popular country - India.
It would be interesting to compare this to the countries of the viewers of 
Netflix, if such data was available.

```{r}
countries <- data_in %>%
  mutate(symbols = strsplit(country, " ,")) %>%
  unnest(symbols) %>%
  mutate(symbols = strsplit(symbols, ",")) %>%
  unnest(symbols) %>%
  data.table()

countries[, symbols := gsub("^ ", "", symbols)]

```

```{r}

titles_by_countries <- countries[, .(title, show_id, symbols, date_added)]

counted_titles_per_country <- titles_by_countries[, .(counts = .N), .(symbols)]
setorder(counted_titles_per_country, -counts)

counted_titles_per_country %>%
  top_n(15) %>%
  ggplot(aes(x = symbols, y = counts)) +
  geom_point() +
  large_font_size +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Productions associated with each country")

top_n_actors <- 10

```

#### Actors

It is quite telling to have a look most popular actors as defined by how many
titles they appear in. The top `r top_n_actors` in the dataset all have more 
than 20 titles to their name. While that does not seem that much given the size
of the dataset, it feels like a lot of titles to have in such a diverse set.

Surprisingly, there is no Western representation - all the actors appear to be 
of Asian heritage, judging just from the names, with a heavy representation from
Bollywood actors. I was a bit surprised to find that the two Japanese names on 
the list are of voice actors, even though that makes sense - Japan creates a lot
of animated movies / TV series.
```{r, fig.width=12}
actors <- data_in %>%
  mutate(cast = strsplit(cast, " ,")) %>%
  unnest(cast) %>%
  mutate(cast = strsplit(cast, ",")) %>%
  unnest(cast) %>%
  data.table()

actors[, cast := gsub("^ ", "", cast)]

titles_by_actors <- actors[, .(show_id, title, cast)]

counted_titles_per_actor <- titles_by_actors[, .(counts = .N), .(cast)]
setorder(counted_titles_per_actor, -counts)

suppressWarnings(counted_titles_per_actor %>%
                   top_n(top_n_actors) %>%
                   ggplot(aes(x = cast, y = counts)) +
                   geom_point())

```

Having a look at how many actors each title has is also interesting. There is a 
very nice bell curve around 8 - 10, with another peak around 1. We can read this 
as most TV shows tend to have about 10 actors quoted, but we also have a large 
number of titles (possibly stand ups) that are quoted with only one person. 

It is important to keep in mind that for some titles we have no actors - 
`r data_in[cast == "", .N] / nrow(data_in)` % of the dataset.
```{r}
number_of_actors <- actors[, .N, .(show_id, title)]

ggplot(number_of_actors, aes(x = N)) +
  geom_histogram(bins = 100) +
  ggtitle("Average number of actor quoted per title")

```

#### Directors

Of course, a movie does not exists with only actors - there are a lot more 
people involved in the production and one of the roles is that of the director.

The same look at most popular directors defined by associated titles yields a
different look at the data set. To start with, the number of associated titles
is a lot fewer than for the actors. Additionally, there is a bit more of a 
varied representation, including one person with a traditionally female name.

```{r}
directors <- data_in %>%
  mutate(director = strsplit(director, ", ")) %>%
  unnest(director) %>%
  mutate(director = strsplit(director, ",")) %>%
  unnest(director) %>%
  data.table()

titles_by_directors <- directors[, .(show_id, title, director)]

counted_titles_per_directors <- titles_by_directors[
  , .(counts = .N), .(director)]
setorder(counted_titles_per_directors, -counts)

counted_titles_per_directors %>%
  top_n(10) %>%
  ggplot(aes(x = director, y = counts)) +
  geom_point()

```

At the same time, having 20 titles associated with your name carries a different
weight if you were the only director as opposed to if you were a director in
a big group. To give us a few details, here is what the distribution of number 
of directors associated with a title looks like. Plotting this on a logged scale 
makes it a bit easier to see where we actually have values and where we 
potentially don't. In this case it is interesting to note that we have at least
some titles with more than 10 directors. While there are a lot of TV series
in the dataset, which could in theory have a different director for each 
episode, it is still interesting to note. 

```{r}
count_directors_per_title <- titles_by_directors[, .N, .(show_id, title)]
ggplot(count_directors_per_title, aes(x = N)) +
  geom_histogram() +
  scale_y_log10()
```

Of course, 10 directors are a lot of people, so let's have a look at the 
titles. My theory was that it is TV shows and anthologies that end up with
so many directors. Unfortunately that does not seem to be supported by the data, 
where most of those titles are movies. There is probably something to explore
here.

```{r}
movie_titles <- count_directors_per_title[N > 4, c("title", "show_id", "N")]

merge(data_in, movie_titles, by = c("show_id", "title"))[
  , c("title", "show_id", "type", "N")]

```

It is important to mention that there are productions in this data set without
directors. To be precise, they represent
`r round(nrow(data_in[director == ""]) / nrow(data_in) * 100, 2)`%
of the total dataset. 
Missing values can be sometimes imputed, but in this case there is nothing we
can really do about this lack besides be aware of it and try to take it into 
account when modelling. 


### Sentiment analysis of the descriptions

When doing sentiment analysis, we are trying to quantify what are the associated
emotions with a given text. In this data set we have two sources of text - the
title and the description. The title would not be a candidate for an analysis - 
it is a very high level description of what is happening in the text and thus 
not good for a nuanced look at the show / movie. A description is also a high 
level look, but at least a bit more of the plot is put in there, so we have a 
chance.

#### Sums of scores
As a first try we have a look at the sum of numeric scores that are associated 
with given words. We get these scores from the AFINN dataset.

As we can expect, the scores tend to peak around 0, however with two separate 
peaks. It could be interesting to try to tease out what are the characteristics 
of the titles that are classified in one camp as opposed to the other.

```{r, message=FALSE}
description_text <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, "word") %>%
  anti_join(stop_words) %>%
  inner_join(get_sentiments("afinn")) %>%
  data.table()

overall_sum_sentiments <- description_text[
  , .(sentiment_score = sum(value)), .(show_id)]

ggplot(overall_sum_sentiments, aes(x = sentiment_score)) +
  geom_histogram() +
  ggtitle("Histogram of the sentiment scores")

```

One way of splitting these titles is by the category they are slotted in. It is 
important to note that one title can have multiple associeated categories, so 
this is not so cut and dry. The plot is a bit hard to read this way - most of 
the categories seem to be on the same levels. However, there are a couple of 
stand out ones. For example, the thriller category is almost always with a 
negative score, while the stand up category is almost always positive. 


```{r}
categories <- data_in %>%
  mutate(categories = strsplit(listed_in, ", ")) %>%
  unnest(categories) %>%
  mutate(categories = strsplit(categories, ",")) %>%
  unnest(categories) %>%
  data.table()

categories_short <- unique(categories[, .(categories, show_id, title)])

categories_afinn <- merge(
  categories_short, overall_sum_sentiments, by = "show_id")

unique(categories_afinn$categories)

ggplot(categories_afinn, aes(x = categories, y = sentiment_score)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Scores per category")
```

One score is not very representative of a whole movie, especially since we are 
calculating it on a description, rather than the whole script of the movie.
That makes the numeric representation of the movie a very high-level
representation of it and we expect a lot of details to get lost. 

That being the case it is perhaps more illuminating to look at associated words,
rather than associated numbers. For that we can use the NRC dataset, which shows
us whether a word is positive or negative without a specific grade associated. 

```{r}
description_text_nrc <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, "word") %>%
  anti_join(stop_words) %>%
  inner_join(get_sentiments("nrc")) %>%
  data.table()

# description_text_nrc

categories_nrc <- merge(categories_short, description_text_nrc, by = "show_id",
                        allow.cartesian = TRUE)
```


Let's have a look at what the distributions are. We have a lot of categories, 
some of them duplicating for movies and TV shows. For ease of access, let's 
have a look at the movies only.
```{r}
categories_nrc <- merge(categories_nrc, data_in[, .(show_id, type)])

ggplot(categories_nrc[
  type == "Movie" & sentiment %in% c("negative", "positive"), ],
  aes(x = sentiment, fill = sentiment)) +
  geom_histogram(stat = "count") +
  facet_wrap(~categories, scales = "free") +
  # theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Positive and negative sentiment counts per movie category")

ggplot(categories_nrc[
  type != "Movie" & sentiment %in% c("negative", "positive"), ],
  aes(x = sentiment, fill = sentiment)) +
  geom_histogram(stat = "count") +
  facet_wrap(~categories, scales = "free") +
  # theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Positive and negative sentiment counts per TV show category")

```


- most popular groups
```{r}
categories %>%
  group_by(type) %>%
  count(categories) %>%
  arrange(desc(n)) %>%
  group_by(type) %>%
  top_n(5) %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = categories, y = n, fill = categories)) +
  geom_col() +
  facet_wrap(~type, scales = "free") +
  theme(axis.text.x = element_text(angle = 45))

```

- inverse frequency on the description
```{r}
text <- data_in %>%
  unnest_tokens(word, description) %>%
  select(show_id, title, word) %>%
  anti_join(stop_words)

word_tf_idf <- text %>%
  count(show_id, word) %>%
  bind_tf_idf(word, show_id, n) %>%
  arrange(desc(tf_idf))

word_tf_idf %>%
  mutate(word = factor(word, levels = rev(unique(word)))) %>%
  arrange(desc(tf_idf)) %>%
  top_n(15) %>%
  ggplot(aes(word, tf_idf, fill = show_id)) +
  geom_col(show.legend = TRUE) +
  labs(x = NULL, y = "tf-idf") +
  coord_flip() +
  ggtitle("The 15 rarest words in the dataset")

```

- most niche groups - the shows in them are not listed in many more groups on 
average
```{r}
number_of_categories_per_show <- categories_short[, .N, .(show_id)]

categories_with_counts <- merge(
  categories_short, number_of_categories_per_show)

categories_with_counts[, percentage_of_categories := 1 / N]
mean_per_category <- categories_with_counts[
  , .(percentage_of_categories = mean(percentage_of_categories)), .(categories)]


ggplot(mean_per_category[percentage_of_categories > 0.5],
       aes(x = categories, y = percentage_of_categories)) +
  geom_point() +
  ggtitle("Most niche categories (appearing on their own most of the time")

```

- correlations of the categories
```{r}
ggplot(categories, aes(x = categories, y = categories)) +
  geom_point()


# run correlations on the dummified categories
dmy <- dummyVars(" ~ .", data = categories[, .(show_id, categories)])
one_hot_encoded <- data.table(predict(dmy, newdata = categories))
one_hot_encoded[, .(lapply(.SD, sum)), .(show_id)]

one_hot_encoded <- one_hot_encoded %>%
  group_by(show_id) %>%
  summarise_each(funs(sum))

new_names <- gsub("categories", "", names(one_hot_encoded))
setnames(one_hot_encoded, names(one_hot_encoded), new_names)

correlations <- cor(one_hot_encoded[, -1])
corrplot::corrplot(correlations, method = "number")
```

The correlations plot is very bare - overall we rarely have something that 
correlates even at 40%, nevermind higher strength correlations.

- how does the distribution of movies change over time - movies produced in 
different countries added in 

```{r}
titles_by_countries
count_name_by_date_country <- titles_by_countries[
  , .N, .(symbols, year(date_added))]

required_countries <- count_name_by_date_country[
  year == 2019 & N > 50, symbols]

count_name_by_date_country %>%
  filter(symbols  %in% required_countries) %>%
  ggplot(aes(x = year, y = log10(N), col = symbols)) +
  geom_line() +
  ggtitle("Additions of shows and movies by year per country (log 10)")

```

- TV shows against movies over time
```{r}
# something sketchy happening here
counts_type <- data_in[, .N, .(type, year(date_added))]
max(counts_type$N)
ggplot(counts_type, aes(x = year, y = N, col = type)) +
  geom_line() +
  ggtitle("Additions of shows and movies by year")
```
